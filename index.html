<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Async Tic Tac Toe</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      background: #f7f7f7;
    }
    h1 { margin-bottom: 10px; }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 8px;
      margin: 20px 0;
    }
    .cell {
      background: white;
      border-radius: 12px;
      font-size: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .cell.disabled {
      cursor: default;
      opacity: 0.6;
    }
    #status {
      font-size: 18px;
      margin-bottom: 10px;
    }
    input, button {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Async Tic Tac Toe</h1>
  <p>Share a game ID with your friend. Play whenever you want.</p>

  <div>
    <input id="gameIdInput" placeholder="Game ID" />
    <button onclick="joinGame()">Join / Create Game</button>
  </div>

  <div id="status">Not connected</div>

  <div id="board"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ðŸ”¥ Replace with your own Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyAhT5uFEHkDYzuSaSWOiTU6HT6e9EQ9pOA",
      authDomain: "async-tic-tac-toe-39fce.firebaseapp.com",
      databaseURL: "https://async-tic-tac-toe-39fce-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "async-tic-tac-toe-39fce",
      storageBucket: "async-tic-tac-toe-39fce.firebasestorage.app",
      messagingSenderId: "708281806819",
      appId: "1:708281806819:web:abe2b0db5ee4731c5cfad6"
    };


    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gameId = null;
    let player = null; // 'X' or 'O'
    let gameRef = null;

    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function renderBoard(board, currentTurn, winner) {
      boardEl.innerHTML = '';
      board.forEach((cell, i) => {
        const div = document.createElement('div');
        div.className = 'cell';
        div.textContent = cell || '';

        const isMyTurn = currentTurn === player;
        if (!cell && isMyTurn && !winner) {
          div.onclick = () => makeMove(i);
        } else {
          div.classList.add('disabled');
        }

        boardEl.appendChild(div);
      });

      if (winner) {
        statusEl.textContent = winner === 'draw' ? 'Draw game ðŸ¤' : `${winner} wins! ðŸŽ‰`;
      } else {
        statusEl.textContent = `You are ${player}. Turn: ${currentTurn}`;
      }
    }

    function joinGame() {
      setStatus('Connectingâ€¦');
      gameId = document.getElementById('gameIdInput').value.trim();
      if (!gameId) return alert('Enter a game ID');

      gameRef = db.ref('games/' + gameId);

      gameRef.once('value', snapshot => {
        console.log('Initial snapshot:', snapshot.val());
        if (!snapshot.exists()) {
          player = 'X';
          setStatus('Connected as X');
          gameRef.set({
            board: Array(9).fill(null),
            turn: 'X',
            players: { X: true },
            winner: null
          });
        } else {
          const data = snapshot.val();
          if (!data.players?.O) {
            player = 'O';
            setStatus('Connected as O');
            gameRef.child('players/O').set(true);
          } else {
            alert('Game already has 2 players');
            return;
          }
        }

        listenToGame();
        // Force initial render in case listener lags
        gameRef.once('value').then(snap => {
          const data = snap.val();
          if (data) {
            renderBoard(data.board, data.turn, data.winner);
            setStatus(`You are ${player}. Turn: ${data.turn}`);
          }
        });
      });
    }

    function listenToGame() {
      setStatus('Waiting for game dataâ€¦');
      gameRef.on('value', snapshot => {
        console.log('Realtime update:', snapshot.val());
        const data = snapshot.val();
        if (!data || !data.board) return;
        renderBoard(data.board, data.turn, data.winner);
        setStatus(`You are ${player}. Turn: ${data.turn}`);
      });
    }

    function makeMove(index) {
      gameRef.transaction(game => {
        if (!game || game.winner) return game;
        if (game.board[index] || game.turn !== player) return game;

        game.board[index] = player;
        game.turn = player === 'X' ? 'O' : 'X';
        game.winner = checkWinner(game.board);
        return game;
      });
    }

    function checkWinner(b) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (const [a,b1,c] of wins) {
        if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
      }
      return b.every(Boolean) ? 'draw' : null;
    }
  </script>
</body>
</html>
